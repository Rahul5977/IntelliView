// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String    @id @default(uuid())
  email       String    @unique
  name        String?
  isValidated Boolean   @default(false)
  picture     String?
  googleId    String?   @unique
  role        UserRole  @default(STUDENT)
  profileData Json?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  resumes     Resume[]
  interviews  Interview[]
  experiences InterviewExperience[]
  submissions PastQuestion[]
}

enum UserRole {
  STUDENT
  ADMIN
  PLACEMENT_COORDINATOR
}

model Resume {
  id              String   @id @default(uuid())
  userId          String
  fileName        String
  fileUrl         String
  fileSize        Int
  mimeType        String
  parsedData      Json? // Extracted text, skills, experience
  skillsExtracted String[]
  createdAt       DateTime @default(now())
  rawText         String?  @db.Text
  vectorId        String?  @unique
  isIndexed       Boolean  @default(false)

  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  interviews Interview[]

  @@index([userId])
}

model Company {
  id          String   @id @default(uuid())
  name        String   @unique
  logoUrl     String?
  description String?
  website     String?
  createdAt   DateTime @default(now())

  interviews    Interview[]
  experiences   InterviewExperience[]
  pastQuestions PastQuestion[]
}

model Interview {
  id          String          @id @default(uuid())
  userId      String
  resumeId    String?
  companyId   String?
  type        InterviewType
  role        String?
  status      InterviewStatus @default(PENDING)
  score       Float?
  duration    Int? // in seconds
  scheduledAt DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime        @default(now())

  user           User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  resume         Resume?            @relation(fields: [resumeId], references: [id])
  company        Company?           @relation(fields: [companyId], references: [id])
  sessions       InterviewSession[]
  proctoringLogs ProctoringLog[]

  @@index([userId])
  @@index([companyId])
}

enum InterviewType {
  MOCK_TECHNICAL
  MOCK_BEHAVIORAL
  MOCK_CODING
  CUSTOM_JD
  COMPANY_SPECIFIC
}

enum InterviewStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  TERMINATED
  CANCELLED
}

model InterviewSession {
  id                 String   @id @default(uuid())
  interviewId        String
  questionId         String
  aiGeneratedText    String?  @db.Text
  answerText         String?
  answerAudioUrl     String?
  answerVideoUrl     String?
  transcript         String?
  score              Float?
  feedback           String?
  duration           Int? // in seconds
  createdAt          DateTime @default(now())
  technicalScore     Float?
  communicationScore Float?
  relevanceScore     Float?

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  question  Question  @relation(fields: [questionId], references: [id])

  @@index([interviewId])
}

model Question {
  id               String           @id @default(uuid())
  role             String?
  difficulty       Difficulty
  techStack        String[]
  questionText     String
  category         QuestionCategory
  expectedKeywords String[]
  createdAt        DateTime         @default(now())

  sessions InterviewSession[]
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum QuestionCategory {
  TECHNICAL
  BEHAVIORAL
  CODING
  SYSTEM_DESIGN
  HR
}

model ProctoringLog {
  id             String        @id @default(uuid())
  interviewId    String
  timestamp      DateTime      @default(now())
  violationType  ViolationType
  severity       Severity
  screenshotUrl  String?
  metadata       Json?
  videoTimestamp Int? // in seconds

  interview Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)

  @@index([interviewId])
}

enum ViolationType {
  TAB_SWITCH
  NO_FACE_DETECTED
  MULTIPLE_FACES
  PHONE_DETECTED
  SUSPICIOUS_GAZE
  MULTIPLE_VOICES
  HIGH_BACKGROUND_NOISE
}

enum Severity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model InterviewExperience {
  id              String     @id @default(uuid())
  userId          String
  companyId       String
  role            String
  interviewDate   DateTime?
  rounds          Int?
  difficulty      Difficulty
  preparationTips String?
  questionsAsked  String[]
  offerStatus     String?
  verified        Boolean    @default(false)
  upvotes         Int        @default(0)
  createdAt       DateTime   @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([companyId])
}

model PastQuestion {
  id            String     @id @default(uuid())
  companyId     String
  submittedBy   String
  role          String
  question      String
  difficulty    Difficulty
  interviewType String // OA, Technical, HR
  verified      Boolean    @default(false)
  upvotes       Int        @default(0)
  createdAt     DateTime   @default(now())

  company   Company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  submitter User    @relation(fields: [submittedBy], references: [id], onDelete: Cascade)

  @@index([companyId])
}
